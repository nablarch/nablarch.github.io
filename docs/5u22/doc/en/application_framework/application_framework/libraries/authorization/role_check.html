


<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta http-equiv='content-language' content='ja'>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>7.15.2. Permission Check by annotation &mdash; ∇Nablarch  5u22 documentation</title>
  

  
  
  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="../../../../_static/custom.css" type="text/css" />
  

  

  
  <link rel="canonical" href="https://nablarch.github.io/docs/LATEST/doc/application_framework/application_framework/libraries/authorization/role_check.html" />
  
    <link rel="top" title="∇Nablarch  5u22 documentation" href="../../../../index.html"/>
        <link rel="up" title="7.15. Permission Check" href="../permission_check.html"/>
        <link rel="next" title="7.16. Service Availability Check" href="../service_availability.html"/>
        <link rel="prev" title="7.15.1. Permission Check by handler" href="permission_check.html"/>

<script defer data-domain="nablarch.github.io,all.fintan" src=https://plausible.io/js/script.js></script>


  
  <script src="../../../../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          
  
  <a href="../../../../index.html" id="sidebar-title" class="icon"> ∇Nablarch 
  

  
    <div id="sidebar-version">Version: 5u22</div>
  </a>

  <div role="search">
    <form id="google-search-form" class="wy-form" method="get" action="https://www.google.co.jp/search">
      <input type="text" name="text" placeholder="Search docs on google" id="text"/>
      <input type="hidden" name="q" id="q"/>
    </form>
  </div>
    
    

        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
  
  
    <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../../../about_nablarch/index.html">What is the Nablarch?</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../../about_nablarch/concept.html">Nablarch Concept</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../../about_nablarch/concept.html#robustness">Robustness</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../about_nablarch/concept.html#testability">Testability</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../about_nablarch/concept.html#ready-to-use">Ready-to-Use</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../../about_nablarch/mvn_module.html">Module List of Nablarch</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../about_nablarch/license.html">Information on Nablarch License</a></li>
</ul>
</li>
<li class="toctree-l1 current"><a class="reference internal" href="../../../index.html">Nablarch Application Framework</a><ul class="current">
<li class="toctree-l2 current"><a class="reference internal" href="../../index.html">Application Framework</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="../../nablarch/index.html">1. What is Nablarch Application Framework?</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../web/index.html">2. Web Application</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../web_service/index.html">3. Web Service</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../batch/index.html">4. Batch Application</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../messaging/index.html">5. Messaging</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../handlers/index.html">6. Standard Handler Provided by Nablarch</a></li>
<li class="toctree-l3 current"><a class="reference internal" href="../index.html">7. Libraries Provided by Nablarch</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../blank_project/index.html">8. Blank Project</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../setting_guide/index.html">9. Nablarch Application Framework Configuration Guide</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../configuration/index.html">10. Default Configuration List</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../cloud_native/index.html">11. Nablarch Cloud Native Support</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../adaptors/index.html">Adaptor</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../adaptors/log_adaptor.html">log Adapter</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../adaptors/router_adaptor.html">Routing Adapter</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../adaptors/webspheremq_adaptor.html">IBM WebSphere MQ Adapter</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../adaptors/jaxrs_adaptor.html">JAX-RS Adapter</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../adaptors/doma_adaptor.html">Doma Adapter</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../adaptors/jsr310_adaptor.html">JSR310(Date and Time API)Adapter</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../adaptors/mail_sender_freemarker_adaptor.html">E-mail FreeMarker Adapter</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../adaptors/mail_sender_thymeleaf_adaptor.html">E-mail Thymeleaf Adapter</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../adaptors/mail_sender_velocity_adaptor.html">E-mail Velocity Adapter</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../adaptors/web_thymeleaf_adaptor.html">Web Application Thymeleaf Adapter</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../adaptors/lettuce_adaptor.html">Lettuce Adapter</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../adaptors/slf4j_adaptor.html">SLF4J Adapter</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../adaptors/micrometer_adaptor.html">Micrometer Adapter</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../example/index.html">Example</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../example/index.html#procedure-to-build-the-environment">Procedure to build the environment</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../example/index.html#application-execution-procedure">Application execution procedure</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../example/index.html#running-on-java-11-or-higher">Running on Java 11 or higher</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../../extension_components/index.html">Nablarch extension component</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../../extension_components/report/index.html">1. Form library</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../extension_components/workflow/doc/index.html">2. Workflow library</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../extension_components/workflow/tool/index.html">3. Workflow definition data generation tool</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../extension_components/etl/index.html">4. ETL</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../extension_components/etl/etl_maven_plugin.html">5. ETL Maven plugin</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../../development_tools/index.html">Nablarch development tools</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../../development_tools/java_static_analysis/index.html">1. Efficient Java Static Checks</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../../development_tools/java_static_analysis/index.html#conduct-syntax-check">1.1. Conduct syntax check</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../development_tools/java_static_analysis/index.html#unify-the-format">1.2. Unify the format</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../development_tools/java_static_analysis/index.html#check-if-unauthorized-apis-are-being-used">1.3. Check if unauthorized APIs are being used</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../../development_tools/ui_dev/index.html">2. Front-end UI development platform for advanced users</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../development_tools/testing_framework/index.html">3. Testing framework</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../../development_tools/testing_framework/guide/development_guide/05_UnitTestGuide/index.html">3.1. How to Execute Unit Tests</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../development_tools/testing_framework/guide/development_guide/06_TestFWGuide/index.html">3.2. How to Use the Automated Test Framework</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../development_tools/testing_framework/guide/development_guide/08_TestTools/index.html">3.3. Tools Used in the Programming Phase</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../../development_tools/toolbox/index.html">4. Useful Tools When Developing Applications</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../../development_tools/toolbox/JspStaticAnalysis/index.html">4.1. JSP Static Analysis Tool</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../development_tools/toolbox/SqlExecutor/SqlExecutor.html">4.2. Nablarch SQL Executor</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../development_tools/toolbox/JspVerifier/JspVerifier.html">4.3. Job Screen JSP Validation Tool</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../../examples/index.html">Nablarch Implementation Examples</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../../examples/01/index.html">Sample Password Encryption Function Using Database</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../../examples/01/0101_PBKDF2PasswordEncryptor.html">Sample Password Encryption Function Using PBKDF2</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../examples/01/index.html#delivery-package">Delivery package</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../examples/01/index.html#summary">Summary</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../examples/01/index.html#structure">Structure</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../examples/01/index.html#how-to-use">How to Use</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../../examples/03/index.html">Display a List of Search Results</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../../examples/03/index.html#delivery-package">Delivery package</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../examples/03/index.html#summary">Summary</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../examples/03/index.html#structure">Structure</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../examples/03/index.html#universaldao-class">UniversalDao class</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../examples/03/index.html#listsearchinfo-class">ListSearchInfo class</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../examples/03/index.html#pagination-class">Pagination class</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../examples/03/index.html#entitylist-class">EntityList class</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../examples/03/index.html#listsearchresult-tag">listSearchResult tag</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../examples/03/index.html#how-to-import-a-sample-implementation-tag-file-into-the-business-application">How to import a sample implementation (tag file) into the business application</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../examples/03/index.html#tag-reference">Tag Reference</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../../examples/04/index.html">Extended Formatter Functions</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../../examples/04/0401_ExtendedDataFormatter.html">Data Formatter Expansion</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../examples/04/0402_ExtendedFieldType.html">Field Type Expansion in the Data Formatter Function</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../../examples/05/index.html">Sample File Management Function Using Database</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../../examples/05/index.html#summary">Summary</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../examples/05/index.html#delivery-package">Delivery package</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../examples/05/index.html#functions">Functions</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../examples/05/index.html#structure">Structure</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../examples/05/index.html#how-to-use">How to Use</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../../examples/08/index.html">Sample of HTML Email Send Function</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../../examples/08/index.html#summary">Summary</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../examples/08/index.html#request">Request</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../examples/08/index.html#structure">Structure</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../examples/08/index.html#implementation-examples">Implementation examples</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../../examples/09/index.html">How to Use a Sample to Send a Digitally Signed Email Using Bouncycastle</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../../examples/09/index.html#environment-preparation">Environment preparation</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../examples/09/index.html#structure-of-digitally-signed-email-send-function">Structure of digitally signed email send function</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../examples/09/index.html#preparation-of-configuration-file">Preparation of configuration file</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../examples/09/index.html#execution">Execution</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../../examples/10/index.html">How to Use the Log Aggregation Sample</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../../examples/10/index.html#list-of-samples-provided">List of samples provided</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../../examples/11/index.html">Messaging Platform Test Simulator Sample</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../../examples/11/index.html#uses">Uses</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../examples/11/index.html#features">Features</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../examples/11/index.html#request">Request</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../examples/11/index.html#how-to-use">How to use</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../examples/11/index.html#expansion-example">Expansion example</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../../examples/12/index.html">Authentication sample using OIDC ID token</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../../examples/12/index.html#delivery-package">Delivery package</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../examples/12/index.html#summary">Summary</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../examples/12/index.html#structure">Structure</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../examples/12/index.html#how-to-use">How to Use</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../../nablarch_api/index.html">Nablarch API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../about_nablarch/versionup_policy.html">Nablarch upgrade policy</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../../about_nablarch/versionup_policy.html#release-unit">Release unit</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../about_nablarch/versionup_policy.html#types-of-upgrades">Types of upgrades</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../about_nablarch/versionup_policy.html#version-numbering-system">Version numbering system</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../about_nablarch/versionup_policy.html#backward-compatibility-policy">Backward compatibility policy</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../../about_nablarch/versionup_policy.html#extent-to-which-backward-compatibility-is-maintained">Extent to which backward compatibility is maintained</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../about_nablarch/versionup_policy.html#contents-of-backward-compatibility-maintenance">Contents of backward compatibility maintenance</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../about_nablarch/versionup_policy.html#backward-compatibility-exception">Backward compatibility exception</a></li>
</ul>
</li>
</ul>
</li>
</ul>

  

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../../index.html">∇Nablarch </a>
        
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          

 



<div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../../../../index.html">Docs</a> &raquo;</li>
      
          <li><a href="../../../index.html">Nablarch Application Framework</a> &raquo;</li>
      
          <li><a href="../../index.html">Application Framework</a> &raquo;</li>
      
          <li><a href="../index.html">7. Libraries Provided by Nablarch</a> &raquo;</li>
      
          <li><a href="../permission_check.html">7.15. Permission Check</a> &raquo;</li>
      
    <li>7.15.2. Permission Check by annotation</li>
    <li class="wy-breadcrumbs-aside">
      <a href="https://github.com/nablarch" class="fa fa-github">GitHub</a>
    </li>
    <li class="wy-breadcrumbs-aside">
        <a href="https://nablarch.github.io/docs/LATEST/doc/index.html" class="ja">日本語</a>
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="permission-check-by-annotation">
<span id="role-check"></span><h1>7.15.2. Permission Check by annotation<a class="headerlink" href="#permission-check-by-annotation" title="Permalink to this headline">¶</a></h1>
<div class="contents local topic" id="table-of-contents">
<p class="topic-title first">Table of contents</p>
<ul class="simple">
<li><a class="reference internal" href="#function-overview" id="id2">Function overview</a><ul>
<li><a class="reference internal" href="#permission-checks-can-be-performed-without-complicated-data-management" id="id3">Permission checks can be performed without complicated data management</a></li>
<li><a class="reference internal" href="#you-can-check-the-permission-by-the-annotation" id="id4">You can check the permission by the annotation</a></li>
<li><a class="reference internal" href="#difference-from-permission-check-by-handler-function" id="id5">Difference from permission check by handler function</a></li>
</ul>
</li>
<li><a class="reference internal" href="#module-list" id="id6">Module list</a></li>
<li><a class="reference internal" href="#how-to-use" id="id7">How to use</a><ul>
<li><a class="reference internal" href="#advance-preparation" id="id8">Advance preparation</a><ul>
<li><a class="reference internal" href="#define-components" id="id9">Define components</a></li>
<li><a class="reference internal" href="#add-to-interceptorsorder" id="id10">Add to interceptorsOrder</a></li>
<li><a class="reference internal" href="#define-the-roles" id="id11">Define the roles</a></li>
<li><a class="reference internal" href="#save-the-user-s-roles" id="id12">Save the user&#8217;s roles</a></li>
</ul>
</li>
<li><a class="reference internal" href="#assign-roles-to-methods-of-actions-with-annotations" id="id13">Assign roles to methods of actions with annotations</a></li>
<li><a class="reference internal" href="#list-checkrole-settings" id="id14">List CheckRole settings</a></li>
<li><a class="reference internal" href="#programmatic-check" id="id15">Programmatic check</a></li>
<li><a class="reference internal" href="#check-in-jsp" id="id16">Check in JSP</a></li>
</ul>
</li>
<li><a class="reference internal" href="#architecture" id="id17">Architecture</a></li>
<li><a class="reference internal" href="#extension-method" id="id18">Extension method</a></li>
</ul>
</div>
<p>This function, like <a class="reference internal" href="permission_check.html"><em>Permission Check by handler</em></a>, performs permission checks on the functions provided by the application.</p>
<div class="section" id="function-overview">
<h2><a class="toc-backref" href="#id2">7.15.2.1. Function overview</a><a class="headerlink" href="#function-overview" title="Permalink to this headline">¶</a></h2>
<div class="section" id="permission-checks-can-be-performed-without-complicated-data-management">
<h3><a class="toc-backref" href="#id3">7.15.2.1.1. Permission checks can be performed without complicated data management</a><a class="headerlink" href="#permission-checks-can-be-performed-without-complicated-data-management" title="Permalink to this headline">¶</a></h3>
<img alt="../../../../_images/conceptual_model.jpg" src="../../../../_images/conceptual_model.jpg" />
<p>Permission check by annotation assigns roles to users.
Also, for functions that you want to check for authorization, assign the roles necessary to perform them.
Then authorization is determined by whether the current user has the role assigned to the function to be performed.</p>
<p>Roles are basically assigned to functions by an annotation.
You can choose any method for assigning users and roles, because the framework does not specify any particular method.</p>
<p>Thus, the permission check by annotation can manage authorization with a simpler data structure than <a class="reference internal" href="permission_check.html"><em>Permission Check by handler</em></a>.</p>
</div>
<div class="section" id="you-can-check-the-permission-by-the-annotation">
<h3><a class="toc-backref" href="#id4">7.15.2.1.2. You can check the permission by the annotation</a><a class="headerlink" href="#you-can-check-the-permission-by-the-annotation" title="Permalink to this headline">¶</a></h3>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="nd">@CheckRole</span><span class="o">(</span><span class="s">&quot;ADMIN&quot;</span><span class="o">)</span>
<span class="kd">public</span> <span class="n">HttpResponse</span> <span class="nf">index</span><span class="o">(</span><span class="n">HttpRequest</span> <span class="n">request</span><span class="o">,</span> <span class="n">ExecutionContext</span> <span class="n">context</span><span class="o">)</span> <span class="o">{</span>
</pre></div>
</div>
<p>In the permission check by annotation, roles can be assigned to methods of the action class using annotations.
The above example defines that the <code class="docutils literal"><span class="pre">ADMIN</span></code> role is required to execute the <code class="docutils literal"><span class="pre">index</span></code> method.</p>
</div>
<div class="section" id="difference-from-permission-check-by-handler-function">
<h3><a class="toc-backref" href="#id5">7.15.2.1.3. Difference from permission check by handler function</a><a class="headerlink" href="#difference-from-permission-check-by-handler-function" title="Permalink to this headline">¶</a></h3>
<p>This section explains the criteria for using this permission check by annotation versus <a class="reference internal" href="permission_check.html"><em>Permission Check by handler</em></a>.</p>
<p>Permission check by annotation manages authorization in units of roles as described above.
And the mechanism for assigning roles and functions is through Java annotations.
Therefore, the use of this permission check by annotation is appropriate when the increase or decrease of roles themselves or changes in functions assigned to roles do not occur frequently.</p>
<p>For example, if the types of roles and combinations of functions that require authorization management have been determined and are not expected to change significantly in the future, this permission check by annotation can be used to easily perform permission checks.</p>
<p>On the other hand, in a system where users want to control permissions according to the department to which they belong, it is expected that the composition of departments and the combination of available functions will change significantly due to organizational changes. If this permission check by annotation is used in such a system, the annotations will need to be rewritten for each change, which will require a large amount of man-hours for modification.
In such a system, it is recommended that <a class="reference internal" href="permission_check.html"><em>Permission Check by handler</em></a> be used to manage the combination of authorizations with data.</p>
</div>
</div>
<div class="section" id="module-list">
<h2><a class="toc-backref" href="#id6">7.15.2.2. Module list</a><a class="headerlink" href="#module-list" title="Permalink to this headline">¶</a></h2>
<div class="highlight-xml"><div class="highlight"><pre><span></span><span class="nt">&lt;dependency&gt;</span>
  <span class="nt">&lt;groupId&gt;</span>com.nablarch.framework<span class="nt">&lt;/groupId&gt;</span>
  <span class="nt">&lt;artifactId&gt;</span>nablarch-common-auth<span class="nt">&lt;/artifactId&gt;</span>
<span class="nt">&lt;/dependency&gt;</span>
<span class="nt">&lt;dependency&gt;</span>
  <span class="nt">&lt;groupId&gt;</span>com.nablarch.framework<span class="nt">&lt;/groupId&gt;</span>
  <span class="nt">&lt;artifactId&gt;</span>nablarch-common-auth-session<span class="nt">&lt;/artifactId&gt;</span>
<span class="nt">&lt;/dependency&gt;</span>
<span class="c">&lt;!-- When using the default configuration --&gt;</span>
<span class="nt">&lt;dependency&gt;</span>
  <span class="nt">&lt;groupId&gt;</span>com.nablarch.configuration<span class="nt">&lt;/groupId&gt;</span>
  <span class="nt">&lt;artifactId&gt;</span>nablarch-main-default-configuration<span class="nt">&lt;/artifactId&gt;</span>
<span class="nt">&lt;/dependency&gt;</span>
</pre></div>
</div>
</div>
<div class="section" id="how-to-use">
<h2><a class="toc-backref" href="#id7">7.15.2.3. How to use</a><a class="headerlink" href="#how-to-use" title="Permalink to this headline">¶</a></h2>
<div class="section" id="advance-preparation">
<h3><a class="toc-backref" href="#id8">7.15.2.3.1. Advance preparation</a><a class="headerlink" href="#advance-preparation" title="Permalink to this headline">¶</a></h3>
<div class="section" id="define-components">
<h4><a class="toc-backref" href="#id9">7.15.2.3.1.1. Define components</a><a class="headerlink" href="#define-components" title="Permalink to this headline">¶</a></h4>
<div class="highlight-xml"><div class="highlight"><pre><span></span><span class="nt">&lt;component</span> <span class="na">name=</span><span class="s">&quot;roleEvaluator&quot;</span>
           <span class="na">class=</span><span class="s">&quot;nablarch.common.authorization.role.BasicRoleEvaluator&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;userRoleResolver&quot;</span> <span class="na">ref=</span><span class="s">&quot;userRoleResolver&quot;</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/component&gt;</span>

<span class="nt">&lt;component</span> <span class="na">name=</span><span class="s">&quot;userRoleResolver&quot;</span>
           <span class="na">class=</span><span class="s">&quot;nablarch.common.authorization.role.session.SessionStoreUserRoleResolver&quot;</span> <span class="nt">/&gt;</span>
</pre></div>
</div>
<p>To use the permission check by annotation, first define the component of the <a class="reference external" href="https://nablarch.github.io/docs/LATEST/javadoc/nablarch/common/authorization/role/BasicRoleEvaluator.html" title="nablarch.common.authorization.role.BasicRoleEvaluator">BasicRoleEvaluator</a>.
And set the <a class="reference external" href="https://nablarch.github.io/docs/LATEST/javadoc/nablarch/common/authorization/role/session/SessionStoreUserRoleResolver.html" title="nablarch.common.authorization.role.session.SessionStoreUserRoleResolver">SessionStoreUserRoleResolver</a>  to the <code class="docutils literal"><span class="pre">userRoleResolver</span></code> property.</p>
<p>Note that this setting is also provided as the default configuration.
When using the default configuration, the same settings can be made by importing the file as follows.</p>
<div class="highlight-xml"><div class="highlight"><pre><span></span><span class="nt">&lt;import</span> <span class="na">file=</span><span class="s">&quot;nablarch/common/authorization/role/session/authorization-session.xml&quot;</span> <span class="nt">/&gt;</span>
</pre></div>
</div>
</div>
<div class="section" id="add-to-interceptorsorder">
<h4><a class="toc-backref" href="#id10">7.15.2.3.1.2. Add to interceptorsOrder</a><a class="headerlink" href="#add-to-interceptorsorder" title="Permalink to this headline">¶</a></h4>
<p>Checking by annotation is realized using Nablarch&#8217;s <a class="reference external" href="https://nablarch.github.io/docs/LATEST/javadoc/nablarch/fw/Interceptor.html" title="nablarch.fw.Interceptor">interceptor</a> mechanism.
Therefore, if you have already defined <code class="docutils literal"><span class="pre">interceptorsOrder</span></code> in your component definition, you need to add the <a class="reference external" href="https://nablarch.github.io/docs/LATEST/javadoc/nablarch/common/authorization/role/CheckRole.html" title="nablarch.common.authorization.role.CheckRole">CheckRole</a>.</p>
<div class="highlight-xml"><div class="highlight"><pre><span></span><span class="c">&lt;!-- The definition of execution order of interceptors. --&gt;</span>
<span class="nt">&lt;list</span> <span class="na">name=</span><span class="s">&quot;interceptorsOrder&quot;</span><span class="nt">&gt;</span>
  <span class="c">&lt;!-- Add the CheckRole --&gt;</span>
  <span class="nt">&lt;value&gt;</span>nablarch.common.authorization.role.CheckRole<span class="nt">&lt;/value&gt;</span>
  <span class="c">&lt;!-- Other interceptor descriptions are omitted. --&gt;</span>
<span class="nt">&lt;/list&gt;</span>
</pre></div>
</div>
<p>If <code class="docutils literal"><span class="pre">interceptorsOrder</span></code> is not defined, this step is not required.</p>
<p>Also, if the default configuration <code class="docutils literal"><span class="pre">nablarch/webui/interceptors.xml</span></code> is loaded, no special action is required.</p>
</div>
<div class="section" id="define-the-roles">
<h4><a class="toc-backref" href="#id11">7.15.2.3.1.3. Define the roles</a><a class="headerlink" href="#define-the-roles" title="Permalink to this headline">¶</a></h4>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Roles</span> <span class="o">{</span>
    <span class="cm">/** The role of the system administrator. */</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">ROLE_ADMIN</span> <span class="o">=</span> <span class="s">&quot;ADMIN&quot;</span><span class="o">;</span>
    <span class="cm">/** The role of the project manager. */</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">ROLE_PROJECT_MANAGER</span> <span class="o">=</span> <span class="s">&quot;PROJECT_MANAGER&quot;</span><span class="o">;</span>
<span class="o">}</span>
</pre></div>
</div>
<p>Define the roles to be used in the annotation.</p>
<p>Roles are defined as any strings.
There are no restrictions on character type or format as long as the system can handle it, but it is recommended that the value be easy to understand what the role is for ease of management.</p>
<p>Although it is also possible to directly specify string literals instead of constants when specifying with annotations, it is recommended that they be managed as constants to facilitate modification.
In the above example, a dedicated constant class is provided, but if a more appropriate class is available, it may be modified to suit the project&#8217;s circumstances.</p>
</div>
<div class="section" id="save-the-user-s-roles">
<h4><a class="toc-backref" href="#id12">7.15.2.3.1.4. Save the user&#8217;s roles</a><a class="headerlink" href="#save-the-user-s-roles" title="Permalink to this headline">¶</a></h4>
<p>The permission check by annotation provides by default an implementation that stores the roles assigned to users in the session store.
By resolving the role assigned to the user and storing it in the session store at login, subsequent permission checks can be performed using the role information stored in the session store.</p>
<p>Below is an example implementation that stores roles in the session store upon login.</p>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="n">List</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">userRoles</span> <span class="o">=</span> <span class="n">resolveUserRoles</span><span class="o">(</span><span class="n">loginId</span><span class="o">);</span>
<span class="n">SessionStoreUserRoleUtil</span><span class="o">.</span><span class="na">save</span><span class="o">(</span><span class="n">userRoles</span><span class="o">,</span> <span class="n">executionContext</span><span class="o">);</span>
</pre></div>
</div>
<p>In this example, the list of roles assigned to the user is resolved based on the login ID, which is then stored in the session store using the <code class="docutils literal"><span class="pre">save</span></code> method of <a class="reference external" href="https://nablarch.github.io/docs/LATEST/javadoc/nablarch/common/authorization/role/session/SessionStoreUserRoleUtil.html" title="nablarch.common.authorization.role.session.SessionStoreUserRoleUtil">SessionStoreUserRoleUtil</a>.</p>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p>The framework does not specify how the <code class="docutils literal"><span class="pre">resolveUserRoles</span></code> method resolves roles from the user.
Therefore, the implementation that resolves the roles will be built to suit the circumstances of each project.</p>
<p class="last">In many cases, it is expected to be resolved from the database.
For example, in a system where the only role is &#8220;administrator,&#8221; the solution could be to look at the value of the &#8220;administrator flag&#8221; in the table that manages user information.
In a system that assigns several roles to a user, it is possible to resolve the user&#8217;s role by searching a table that associates users with roles.</p>
</div>
</div>
</div>
<div class="section" id="assign-roles-to-methods-of-actions-with-annotations">
<h3><a class="toc-backref" href="#id13">7.15.2.3.2. Assign roles to methods of actions with annotations</a><a class="headerlink" href="#assign-roles-to-methods-of-actions-with-annotations" title="Permalink to this headline">¶</a></h3>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="nd">@CheckRole</span><span class="o">(</span><span class="n">Roles</span><span class="o">.</span><span class="na">ROLE_ADMIN</span><span class="o">)</span>
<span class="kd">public</span> <span class="n">HttpResponse</span> <span class="nf">index</span><span class="o">(</span><span class="n">HttpRequest</span> <span class="n">request</span><span class="o">,</span> <span class="n">ExecutionContext</span> <span class="n">context</span><span class="o">)</span> <span class="o">{</span>
</pre></div>
</div>
<p>You can assign roles to an action method by the <code class="docutils literal"><span class="pre">value</span></code> of <a class="reference external" href="https://nablarch.github.io/docs/LATEST/javadoc/nablarch/common/authorization/role/CheckRole.html" title="nablarch.common.authorization.role.CheckRole">CheckRole</a> annotation.
In the above example, the <code class="docutils literal"><span class="pre">ADMIN</span></code> role is assigned to the <code class="docutils literal"><span class="pre">index</span></code> method.
This allows the <code class="docutils literal"><span class="pre">index</span></code> method to be executed only by users with the <code class="docutils literal"><span class="pre">ADMIN</span></code> role.
If a user without the <code class="docutils literal"><span class="pre">ADMIN</span></code> role tries to execute a method, <a class="reference external" href="https://nablarch.github.io/docs/LATEST/javadoc/nablarch/fw/results/Forbidden.html" title="nablarch.fw.results.Forbidden">Forbidden</a> is thrown.</p>
<p>If you want assign multiple roles, you can specify by an array.
An example implementation is shown below.</p>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="nd">@CheckRole</span><span class="o">({</span><span class="n">Roles</span><span class="o">.</span><span class="na">ROLE_ADMIN</span><span class="o">,</span> <span class="n">Roles</span><span class="o">.</span><span class="na">ROLE_PROJECT_MANAGER</span><span class="o">})</span>
<span class="kd">public</span> <span class="n">HttpResponse</span> <span class="nf">index</span><span class="o">(</span><span class="n">HttpRequest</span> <span class="n">request</span><span class="o">,</span> <span class="n">ExecutionContext</span> <span class="n">context</span><span class="o">)</span> <span class="o">{</span>
</pre></div>
</div>
<p>In this case, the <code class="docutils literal"><span class="pre">ADMIN</span></code> and <code class="docutils literal"><span class="pre">PROJECT_MANAGER</span></code> roles must both be held (AND condition) in order to execute the <code class="docutils literal"><span class="pre">index</span></code> method.</p>
<p>Set <code class="docutils literal"><span class="pre">anyOf</span></code> to <code class="docutils literal"><span class="pre">true</span></code> if you want an OR condition.
An example implementation is shown below.</p>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="nd">@CheckRole</span><span class="o">(</span>
    <span class="n">value</span> <span class="o">=</span> <span class="o">{</span><span class="n">Roles</span><span class="o">.</span><span class="na">ROLE_ADMIN</span><span class="o">,</span> <span class="n">Roles</span><span class="o">.</span><span class="na">ROLE_PROJECT_MANAGER</span><span class="o">},</span>
    <span class="n">anyOf</span> <span class="o">=</span> <span class="kc">true</span>
<span class="o">)</span>
<span class="kd">public</span> <span class="n">HttpResponse</span> <span class="nf">index</span><span class="o">(</span><span class="n">HttpRequest</span> <span class="n">request</span><span class="o">,</span> <span class="n">ExecutionContext</span> <span class="n">context</span><span class="o">)</span> <span class="o">{</span>
</pre></div>
</div>
<p>In the above example, to execute the <code class="docutils literal"><span class="pre">index</span></code> method, a user need to have either the <code class="docutils literal"><span class="pre">ADMIN</span></code> or <code class="docutils literal"><span class="pre">PROJECT_MANAGER</span></code> role.</p>
</div>
<div class="section" id="list-checkrole-settings">
<h3><a class="toc-backref" href="#id14">7.15.2.3.3. List CheckRole settings</a><a class="headerlink" href="#list-checkrole-settings" title="Permalink to this headline">¶</a></h3>
<p>To check for errors in <a class="reference external" href="https://nablarch.github.io/docs/LATEST/javadoc/nablarch/common/authorization/role/CheckRole.html" title="nablarch.common.authorization.role.CheckRole">CheckRole</a> annotations set for action methods, this function is provided to list the annotation setting status.
By using this function, it will be possible to check whether there are any omissions in the annotation settings and whether the set contents are excessive or insufficient.</p>
<p>This function is achieved by collecting annotation setting information at system startup and outputting them to the log at the debug level.
The configuration method is described below.</p>
<p>First, define the <a class="reference external" href="https://nablarch.github.io/docs/LATEST/javadoc/nablarch/common/authorization/role/CheckRoleLogger.html" title="nablarch.common.authorization.role.CheckRoleLogger">CheckRoleLogger</a> component as follows.</p>
<div class="highlight-xml"><div class="highlight"><pre><span></span><span class="c">&lt;!-- Components that need to be initialized --&gt;</span>
<span class="nt">&lt;component</span> <span class="na">name=</span><span class="s">&quot;initializer&quot;</span>
           <span class="na">class=</span><span class="s">&quot;nablarch.core.repository.initialization.BasicApplicationInitializer&quot;</span><span class="nt">&gt;</span>
  <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;initializeList&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;list&gt;</span>
      <span class="c">&lt;!-- Omit other components that require initialization. --&gt;</span>

      <span class="nt">&lt;component</span> <span class="na">class=</span><span class="s">&quot;nablarch.common.authorization.role.CheckRoleLogger&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;targetPackage&quot;</span> <span class="na">value=</span><span class="s">&quot;com.nablarch.example.app.web.action&quot;</span> <span class="nt">/&gt;</span>
      <span class="nt">&lt;/component&gt;</span>
    <span class="nt">&lt;/list&gt;</span>
  <span class="nt">&lt;/property&gt;</span>
<span class="nt">&lt;/component&gt;</span>
</pre></div>
</div>
<p><a class="reference external" href="https://nablarch.github.io/docs/LATEST/javadoc/nablarch/common/authorization/role/CheckRoleLogger.html" title="nablarch.common.authorization.role.CheckRoleLogger">CheckRoleLogger</a> is set in the <code class="docutils literal"><span class="pre">initializeList</span></code> of the <a class="reference external" href="https://nablarch.github.io/docs/LATEST/javadoc/nablarch/core/repository/initialization/BasicApplicationInitializer.html" title="nablarch.core.repository.initialization.BasicApplicationInitializer">BasicApplicationInitializer</a> as the component that needs to be initialized.
Also, at this time, specify the package in which action classes exist in the <code class="docutils literal"><span class="pre">targetPackage</span></code> property (including subpackages).</p>
<p>By default, classes with names ending in <code class="docutils literal"><span class="pre">Action</span></code> are processed.
This setting can be changed by specifying any regular expression for the <code class="docutils literal"><span class="pre">targetClassPattern</span></code> property.
See <a class="reference external" href="https://nablarch.github.io/docs/LATEST/javadoc/nablarch/common/authorization/role/CheckRoleLogger.html" title="nablarch.common.authorization.role.CheckRoleLogger">CheckRoleLogger</a>&#8216;s Javadoc for details.</p>
<p>After completing the above settings, start the system with the log level set to debug level.
This will result in the following log output at system startup.</p>
<div class="highlight-text"><div class="highlight"><pre><span></span>2023-01-11 14:29:31.643 -DEBUG- nablarch.common.authorization.role.CheckRoleLogger [null] boot_proc = [] proc_sys = [nablarch-example-web] req_id = [null] usr_id = [null] CheckRole Annotation Settings
class signature       role    anyOf
com.nablarch.example.app.web.action.AuthenticationAction      index(nablarch.fw.web.HttpRequest, nablarch.fw.ExecutionContext)
(omission)
com.nablarch.example.app.web.action.ProjectBulkAction update(nablarch.fw.web.HttpRequest, nablarch.fw.ExecutionContext)
com.nablarch.example.app.web.action.ProjectUploadAction       index(nablarch.fw.web.HttpRequest, nablarch.fw.ExecutionContext)        ADMIN   true
com.nablarch.example.app.web.action.ProjectUploadAction       index(nablarch.fw.web.HttpRequest, nablarch.fw.ExecutionContext)        PROJECT_MANAGER true
</pre></div>
</div>
<p>The following elements are output in the log, separated by tabs.</p>
<table border="1" class="colwidths-given docutils" id="id1">
<caption><span class="caption-text">log output element</span><a class="headerlink" href="#id1" title="Permalink to this table">¶</a></caption>
<colgroup>
<col width="6%" />
<col width="31%" />
<col width="63%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Element</th>
<th class="head">Description</th>
<th class="head">Output example</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><code class="docutils literal"><span class="pre">class</span></code></td>
<td>Fully qualified name of the class.</td>
<td><code class="docutils literal"><span class="pre">com.nablarch.example.app.web.action.ProjectUploadAction</span></code></td>
</tr>
<tr class="row-odd"><td><code class="docutils literal"><span class="pre">signature</span></code></td>
<td>Method signature</td>
<td><code class="docutils literal"><span class="pre">upload(nablarch.fw.web.HttpRequest,</span> <span class="pre">nablarch.fw.ExecutionContext)</span></code></td>
</tr>
<tr class="row-even"><td><code class="docutils literal"><span class="pre">role</span></code></td>
<td>Role assigned (empty if not annotated).</td>
<td><code class="docutils literal"><span class="pre">ADMIN</span></code></td>
</tr>
<tr class="row-odd"><td><code class="docutils literal"><span class="pre">anyOf</span></code></td>
<td>The value set to <code class="docutils literal"><span class="pre">anyOf</span></code> in <code class="docutils literal"><span class="pre">&#64;CheckRole</span></code> (empty if not annotated).</td>
<td><code class="docutils literal"><span class="pre">false</span></code></td>
</tr>
</tbody>
</table>
<p>If multiple roles are assigned, each role is output on a separate line.
For example, in the above output example, we see that the <code class="docutils literal"><span class="pre">index</span></code> method of <code class="docutils literal"><span class="pre">ProjectUploadAction</span></code> is assigned two roles, <code class="docutils literal"><span class="pre">ADMIN</span></code> and <code class="docutils literal"><span class="pre">PROJECT_MANAGER</span></code>.
When replaced by an implementation, this would be set up as follows.</p>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="nd">@CheckRole</span><span class="o">(</span>
    <span class="n">value</span> <span class="o">=</span> <span class="o">{</span><span class="n">Roles</span><span class="o">.</span><span class="na">ROLE_ADMIN</span><span class="o">,</span> <span class="n">Roles</span><span class="o">.</span><span class="na">ROLE_PROJECT_MANAGER</span><span class="o">},</span>
    <span class="n">anyOf</span> <span class="o">=</span> <span class="kc">true</span>
<span class="o">)</span>
<span class="kd">public</span> <span class="n">HttpResponse</span> <span class="nf">index</span><span class="o">(</span><span class="n">HttpRequest</span> <span class="n">request</span><span class="o">,</span> <span class="n">ExecutionContext</span> <span class="n">context</span><span class="o">)</span> <span class="o">{</span>
</pre></div>
</div>
</div>
<div class="section" id="programmatic-check">
<h3><a class="toc-backref" href="#id15">7.15.2.3.4. Programmatic check</a><a class="headerlink" href="#programmatic-check" title="Permalink to this headline">¶</a></h3>
<p>The presence or absence of a role can be checked anywhere in the program.</p>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="o">(</span><span class="n">CheckRoleUtil</span><span class="o">.</span><span class="na">checkRole</span><span class="o">(</span><span class="n">Roles</span><span class="o">.</span><span class="na">ROLE_ADMIN</span><span class="o">,</span> <span class="n">executionContext</span><span class="o">))</span> <span class="o">{</span>
    <span class="c1">// Processing when user has the ADMIN role</span>
<span class="o">}</span>
</pre></div>
</div>
<p>To programmatic check the presence or absence of a role, use <a class="reference external" href="https://nablarch.github.io/docs/LATEST/javadoc/nablarch/common/authorization/role/CheckRoleUtil.html" title="nablarch.common.authorization.role.CheckRoleUtil">CheckRoleUtil</a>.
In the above example, the <code class="docutils literal"><span class="pre">checkRole</span></code> method is used to check if the current user has the <code class="docutils literal"><span class="pre">ADMIN</span></code> role.</p>
<p>Multiple roles can be checked using the <code class="docutils literal"><span class="pre">checkRoleAllOf</span></code> or <code class="docutils literal"><span class="pre">checkRoleAnyOf</span></code> methods.</p>
</div>
<div class="section" id="check-in-jsp">
<h3><a class="toc-backref" href="#id16">7.15.2.3.5. Check in JSP</a><a class="headerlink" href="#check-in-jsp" title="Permalink to this headline">¶</a></h3>
<p><a class="reference internal" href="permission_check.html"><em>Permission Check by handler</em></a> provides a mechanism for JSP custom tags to perform permision checks and automatically show or hide buttons.
However, this permission check by annotation does not provide such a mechanism.</p>
<p>Therefore, this section describes how to control the display of tags in JSP by role after adopting this permission check by annotation.</p>
<p>The control of display by role is achieved by storing the results of the check on the server side in a session store or other location.
An example implementation is shown below.</p>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="n">UserContext</span> <span class="n">userContext</span> <span class="o">=</span> <span class="k">new</span> <span class="n">UserContext</span><span class="o">();</span>
<span class="n">userContext</span><span class="o">.</span><span class="na">setAdmin</span><span class="o">(</span><span class="n">CheckRoleUtil</span><span class="o">.</span><span class="na">checkRole</span><span class="o">(</span><span class="n">Roles</span><span class="o">.</span><span class="na">ROLE_ADMIN</span><span class="o">,</span> <span class="n">executionContext</span><span class="o">));</span>
<span class="n">userContext</span><span class="o">.</span><span class="na">setProjectManager</span><span class="o">(</span><span class="n">CheckRoleUtil</span><span class="o">.</span><span class="na">checkRole</span><span class="o">(</span><span class="n">Roles</span><span class="o">.</span><span class="na">ROLE_PROJECT_MANAGER</span><span class="o">,</span> <span class="n">executionContext</span><span class="o">));</span>

<span class="n">SessionUtil</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">executionContext</span><span class="o">,</span> <span class="s">&quot;userContext&quot;</span><span class="o">,</span> <span class="n">userContext</span><span class="o">);</span>
</pre></div>
</div>
<p>In this example, the result of check the user&#8217;s role at login is stored in the <code class="docutils literal"><span class="pre">UserContext</span></code> class and stored in the session store (<code class="docutils literal"><span class="pre">UserContext</span></code> is just Java Beans, created as needed for each project).
This will allow you to use EL expressions and JSTL in JSP to control the display as follows</p>
<div class="highlight-jsp"><div class="highlight"><pre><span></span><span class="nt">&lt;c:if</span> <span class="na">test=</span><span class="s">&quot;${userContext.admin}&quot;</span><span class="nt">&gt;</span>
  <span class="k">&lt;%-</span><span class="o">-</span> <span class="n">Show</span> <span class="n">when</span> <span class="n">a</span> <span class="n">user</span> <span class="n">has</span> <span class="n">the</span> <span class="n">ADMIN</span> <span class="n">role</span> <span class="o">--</span><span class="k">%&gt;</span>
<span class="nt">&lt;/c:if&gt;</span>
<span class="nt">&lt;c:if</span> <span class="na">test=</span><span class="s">&quot;${userContext.projectManager}&quot;</span><span class="nt">&gt;</span>
  <span class="k">&lt;%-</span><span class="o">-</span> <span class="n">Show</span> <span class="n">when</span> <span class="n">a</span> <span class="n">user</span> <span class="n">has</span> <span class="n">the</span> <span class="n">PROJECT_MANAGER</span> <span class="n">role</span>  <span class="o">--</span><span class="k">%&gt;</span>
<span class="nt">&lt;/c:if&gt;</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="architecture">
<h2><a class="toc-backref" href="#id17">7.15.2.4. Architecture</a><a class="headerlink" href="#architecture" title="Permalink to this headline">¶</a></h2>
<p>This section explains how the permission check by annotation works.</p>
<img alt="../../../../_images/architecture.png" src="../../../../_images/architecture.png" />
<p>The execution of the check process using annotations is realized using Nablarch&#8217;s <a class="reference external" href="https://nablarch.github.io/docs/LATEST/javadoc/nablarch/fw/Interceptor.html" title="nablarch.fw.Interceptor">interceptor</a> mechanism.
The <a class="reference external" href="https://nablarch.github.io/docs/LATEST/javadoc/nablarch/common/authorization/role/CheckRole.html" title="nablarch.common.authorization.role.CheckRole">CheckRole</a> annotation is an implementation of this interceptor.</p>
<p><a class="reference external" href="https://nablarch.github.io/docs/LATEST/javadoc/nablarch/common/authorization/role/CheckRole.html" title="nablarch.common.authorization.role.CheckRole">CheckRole</a> and <a class="reference external" href="https://nablarch.github.io/docs/LATEST/javadoc/nablarch/common/authorization/role/CheckRoleUtil.html" title="nablarch.common.authorization.role.CheckRoleUtil">CheckRoleUtil</a> themselves do not perform permission checks directly, but delegate the process to the <a class="reference external" href="https://nablarch.github.io/docs/LATEST/javadoc/nablarch/common/authorization/role/RoleEvaluator.html" title="nablarch.common.authorization.role.RoleEvaluator">RoleEvaluator</a>.
The instace of the <a class="reference external" href="https://nablarch.github.io/docs/LATEST/javadoc/nablarch/common/authorization/role/RoleEvaluator.html" title="nablarch.common.authorization.role.RoleEvaluator">RoleEvaluator</a> is obtained from the <a class="reference external" href="https://nablarch.github.io/docs/LATEST/javadoc/nablarch/core/repository/SystemRepository.html" title="nablarch.core.repository.SystemRepository">SystemRepository</a> by name <code class="docutils literal"><span class="pre">roleEvaluator</span></code>
The user ID to be passed to the check process is obtained from the <code class="docutils literal"><span class="pre">getUserId</span></code> method of the <a class="reference external" href="https://nablarch.github.io/docs/LATEST/javadoc/nablarch/core/ThreadContext.html" title="nablarch.core.ThreadContext">ThreadContext</a>.</p>
<p>As the default implementation class of <a class="reference external" href="https://nablarch.github.io/docs/LATEST/javadoc/nablarch/common/authorization/role/RoleEvaluator.html" title="nablarch.common.authorization.role.RoleEvaluator">RoleEvaluator</a>, the permission check by annotation provides a class called <a class="reference external" href="https://nablarch.github.io/docs/LATEST/javadoc/nablarch/common/authorization/role/BasicRoleEvaluator.html" title="nablarch.common.authorization.role.BasicRoleEvaluator">BasicRoleEvaluator</a>.
This class is simple enough to compare the roles associated with a user with the roles passed as an argument and check if the condition is met.
And, that the resolution of roles associated with a user is delegated to <a class="reference external" href="https://nablarch.github.io/docs/LATEST/javadoc/nablarch/common/authorization/role/UserRoleResolver.html" title="nablarch.common.authorization.role.UserRoleResolver">UserRoleResolver</a>.</p>
<p>The <a class="reference external" href="https://nablarch.github.io/docs/LATEST/javadoc/nablarch/common/authorization/role/session/SessionStoreUserRoleResolver.html" title="nablarch.common.authorization.role.session.SessionStoreUserRoleResolver">SessionStoreUserRoleResolver</a> is provided as the default implementation of <a class="reference external" href="https://nablarch.github.io/docs/LATEST/javadoc/nablarch/common/authorization/role/UserRoleResolver.html" title="nablarch.common.authorization.role.UserRoleResolver">UserRoleResolver</a>.
This class resolves the user&#8217;s roles with information stored in the session store.</p>
</div>
<div class="section" id="extension-method">
<h2><a class="toc-backref" href="#id18">7.15.2.5. Extension method</a><a class="headerlink" href="#extension-method" title="Permalink to this headline">¶</a></h2>
<p>From the foregoing description of the mechanism, it can be seen that you can extend to any processing by replacing the <a class="reference external" href="https://nablarch.github.io/docs/LATEST/javadoc/nablarch/common/authorization/role/RoleEvaluator.html" title="nablarch.common.authorization.role.RoleEvaluator">RoleEvaluator</a> or <a class="reference external" href="https://nablarch.github.io/docs/LATEST/javadoc/nablarch/common/authorization/role/UserRoleResolver.html" title="nablarch.common.authorization.role.UserRoleResolver">UserRoleResolver</a> entity.</p>
<p>Replacing the <a class="reference external" href="https://nablarch.github.io/docs/LATEST/javadoc/nablarch/common/authorization/role/RoleEvaluator.html" title="nablarch.common.authorization.role.RoleEvaluator">RoleEvaluator</a> entity can be accomplished by creating your own class that implements the <a class="reference external" href="https://nablarch.github.io/docs/LATEST/javadoc/nablarch/common/authorization/role/RoleEvaluator.html" title="nablarch.common.authorization.role.RoleEvaluator">RoleEvaluator</a> and registering that class as a component under the name <code class="docutils literal"><span class="pre">roleEvaluator</span></code>.</p>
<div class="highlight-xml"><div class="highlight"><pre><span></span><span class="nt">&lt;component</span> <span class="na">name=</span><span class="s">&quot;roleEvaluator&quot;</span> <span class="na">class=</span><span class="s">&quot;com.example.CustomRoleEvaluator&quot;</span> <span class="nt">/&gt;</span>
</pre></div>
</div>
<p>If you want to use <a class="reference external" href="https://nablarch.github.io/docs/LATEST/javadoc/nablarch/common/authorization/role/BasicRoleEvaluator.html" title="nablarch.common.authorization.role.BasicRoleEvaluator">BasicRoleEvaluator</a> for the <a class="reference external" href="https://nablarch.github.io/docs/LATEST/javadoc/nablarch/common/authorization/role/RoleEvaluator.html" title="nablarch.common.authorization.role.RoleEvaluator">RoleEvaluator</a> entity and replace only the <a class="reference external" href="https://nablarch.github.io/docs/LATEST/javadoc/nablarch/common/authorization/role/UserRoleResolver.html" title="nablarch.common.authorization.role.UserRoleResolver">UserRoleResolver</a> entity, simply replace the component that is set to the <code class="docutils literal"><span class="pre">userRoleResolver</span></code> property of <a class="reference external" href="https://nablarch.github.io/docs/LATEST/javadoc/nablarch/common/authorization/role/BasicRoleEvaluator.html" title="nablarch.common.authorization.role.BasicRoleEvaluator">BasicRoleEvaluator</a>.
If you are using the default configuration, it is defined to set a component named <code class="docutils literal"><span class="pre">userRoleResolver</span></code>, which can be replaced by defining a component of your own class with the same name.</p>
<div class="highlight-xml"><div class="highlight"><pre><span></span><span class="nt">&lt;component</span> <span class="na">name=</span><span class="s">&quot;userRoleResolver&quot;</span> <span class="na">class=</span><span class="s">&quot;com.example.CustomUserRoleResolver&quot;</span> <span class="nt">/&gt;</span>
</pre></div>
</div>
</div>
</div>


           </div>
           <div class="articleComments">
            
           </div>
          </div>
          <footer>

    <hr/>

    <div role="contentinfo">
        <p>
            &copy; Copyright 2010-2023, TIS Inc.
        </p>
    </div>
    Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../../../../',
            VERSION:'5u22',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: ''
        };
    </script>
      <script type="text/javascript" src="../../../../_static/jquery.js"></script>
      <script type="text/javascript" src="../../../../_static/underscore.js"></script>
      <script type="text/javascript" src="../../../../_static/doctools.js"></script>
      <script type="text/javascript" src="../../../../_static/custom.js"></script>

  

  
  
    <script type="text/javascript" src="../../../../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>